<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>테스트 웹사이트</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    input, button { margin: 5px 0; padding: 5px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    .list { margin-top: 10px; max-height: 200px; overflow-y: auto; }
    .list-item { margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
</style>
</head>
<body>

<h1>서버 API 테스트 사이트</h1>

<!-- 1. 학교 검색 -->
<div class="section">
    <h2>1. 학교 검색 및 선택</h2>
    <input type="text" id="schoolName" placeholder="학교 이름 입력" oninput="searchSchoolsDebounced()">
    <div id="schoolResults" class="list"></div>
    <div>선택된 학교 DB ID: <span id="selectedSchoolId">없음</span></div>
</div>

<!-- 2. 사용자 등록 -->
<div class="section">
    <h2>2. 사용자 등록</h2>
    <input type="text" id="userIdname" placeholder="ID (idname)">
    <input type="text" id="userName" placeholder="이름">
    <input type="password" id="userPassword" placeholder="비밀번호">
    <button onclick="registerUser()">등록</button>
    <div id="registerResult"></div>
</div>

<script>
let selectedSchool = null;
let searchTimeout = null;

// ====== 디바운스 처리 ======
function searchSchoolsDebounced() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(searchSchools, 300); // 0.3초 지연
}

// ====== 학교 검색 ======
async function searchSchools() {
    const name = document.getElementById('schoolName').value.trim();
    const container = document.getElementById('schoolResults');
    container.innerHTML = '';
    if (!name) return;

    try {
        const res = await fetch(`/api/schools/search?name=${encodeURIComponent(name)}`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
            data.data.forEach(s => {
                const div = document.createElement('div');
                div.className = 'list-item';
                
                const span = document.createElement('span');
                span.textContent = `[${s.schoolCode}] ${s.schoolName} (${s.schoolType})`;

                const btn = document.createElement('button');
                btn.textContent = '선택';
                btn.onclick = () => selectSchool(s);

                div.appendChild(span);
                div.appendChild(btn);
                container.appendChild(div);
            });
        } else {
            container.textContent = '검색 결과가 없습니다.';
        }
    } catch (err) {
        console.error(err);
        container.textContent = '검색 중 오류가 발생했습니다.';
    }
}

// ====== 학교 선택 및 DB 등록 ======
async function selectSchool(school) {
    try {
        const res = await fetch('/api/schools', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: school.schoolName, externalId: school.schoolCode })
        });
        const data = await res.json();

        if (!data.success) {
            alert('학교 등록 실패: ' + (data.error || '알 수 없음'));
            return;
        }

        const dbId = data.data?.id;
        if (!dbId) {
            alert('학교 등록 실패: DB ID를 가져올 수 없음');
            return;
        }

        selectedSchool = { id: dbId, externalId: school.schoolCode };
        document.getElementById('selectedSchoolId').textContent = dbId;
        alert(`${school.schoolName} 선택됨!`);
    } catch (err) {
        console.error(err);
        alert('학교 선택 중 오류가 발생했습니다.');
    }
}

// ====== 사용자 등록 ======
async function registerUser() {
    if (!selectedSchool) {
        alert('학교를 먼저 선택하세요.');
        return;
    }

    const user = {
        idname: document.getElementById('userIdname').value.trim(),
        name: document.getElementById('userName').value.trim(),
        password: document.getElementById('userPassword').value,
        schoolId: selectedSchool.id
    };

    if (!user.idname || !user.name || !user.password) {
        alert('ID, 이름, 비밀번호를 모두 입력하세요.');
        return;
    }

    try {
        const res = await fetch('/api/users/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
        });
        const data = await res.json();
        document.getElementById('registerResult').textContent = data.success
            ? `등록 성공! ID: ${data.userId}`
            : `실패: ${data.error}`;
    } catch (err) {
        console.error(err);
        document.getElementById('registerResult').textContent = '등록 중 오류가 발생했습니다.';
    }
}
</script>

</body>
</html>
