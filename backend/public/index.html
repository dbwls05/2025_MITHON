<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>사용자 키워드 설정</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    input, select, button { margin: 5px 0; padding: 5px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    .list { margin-top: 10px; }
    .list-item { margin-bottom: 5px; }
    .keyword { display: inline-block; padding: 5px 10px; border: 1px solid #666; border-radius: 5px; margin: 3px; cursor: pointer; }
    .selected { background-color: #4caf50; color: white; }
</style>
</head>
<body>

<h1>사용자 키워드 설정</h1>

<div class="section">
    <h2>1. 사용자 선택</h2>
    <input type="text" id="userIdInput" placeholder="사용자 ID">
    <button onclick="loadUser()">사용자 조회</button>
    <div id="userInfo"></div>
</div>

<div class="section">
    <h2>2. 키워드 선택</h2>
    <div id="keywordList" class="list"></div>
    <button onclick="saveKeywords()">선택한 키워드 저장</button>
    <div id="saveResult"></div>
</div>

<div class="section">
    <h2>3. 현재 사용자 키워드</h2>
    <div id="currentKeywords"></div>
</div>

<script>
let selectedUserId = null;   // numeric DB id
let selectedKeywords = [];

// 사용자 조회 (idname으로)
async function loadUser() {
    const idname = document.getElementById('userIdInput').value.trim();
    if (!idname) return alert('사용자 ID를 입력하세요');

    try {
        const res = await fetch(`/api/users/idname/${encodeURIComponent(idname)}`);
        const data = await res.json();

        if (data.success) {
            selectedUserId = data.user.id;
            document.getElementById('userInfo').textContent = `사용자: ${data.user.name} (ID: ${data.user.id})`;

            await loadKeywords();
            await loadUserKeywords();
        } else {
            selectedUserId = null;
            document.getElementById('userInfo').textContent = `사용자 조회 실패: ${data.error}`;
            document.getElementById('currentKeywords').innerHTML = '';
            selectedKeywords = [];
            document.querySelectorAll('#keywordList .keyword').forEach(div => div.classList.remove('selected'));
        }
    } catch (err) {
        console.error(err);
        alert('사용자 조회 중 오류 발생');
    }
}

// 전체 키워드 불러오기
async function loadKeywords() {
    const res = await fetch('/api/keywords');
    const data = await res.json();

    const container = document.getElementById('keywordList');
    container.innerHTML = '';
    selectedKeywords = [];

    if (data.success && data.data.length > 0) {
        data.data.forEach(k => {
            const div = document.createElement('div');
            div.className = 'keyword';
            div.textContent = k.word;
            div.dataset.id = k.id;

            div.onclick = () => {
                div.classList.toggle('selected');
                const id = parseInt(div.dataset.id);
                if (selectedKeywords.includes(id)) {
                    selectedKeywords = selectedKeywords.filter(x => x !== id);
                } else {
                    selectedKeywords.push(id);
                }
            }

            container.appendChild(div);
        });
    }
}

// 현재 사용자 키워드 불러오기
async function loadUserKeywords() {
    if (!selectedUserId) return;

    try {
        const res = await fetch(`/api/users/${selectedUserId}/keywords`);
        const data = await res.json();
        const container = document.getElementById('currentKeywords');
        container.innerHTML = '';

        if (data.success && data.data.length > 0) {
            data.data.forEach(k => {
                const div = document.createElement('div');
                div.textContent = k.word;
                container.appendChild(div);
            });

            // 선택 표시 업데이트
            const keywordDivs = document.querySelectorAll('#keywordList .keyword');
            keywordDivs.forEach(div => {
                const id = parseInt(div.dataset.id);
                if (data.data.some(k => k.id === id)) {
                    div.classList.add('selected');
                    if (!selectedKeywords.includes(id)) selectedKeywords.push(id);
                } else {
                    div.classList.remove('selected');
                }
            });
        } else {
            selectedKeywords = [];
            document.querySelectorAll('#keywordList .keyword').forEach(div => div.classList.remove('selected'));
        }
    } catch (err) {
        console.error(err);
        alert('사용자 키워드 불러오기 실패');
    }
}

// 선택한 키워드 저장
async function saveKeywords() {
    if (!selectedUserId) return alert('사용자를 먼저 선택하세요');

    try {
        const res = await fetch(`/api/users/${selectedUserId}/keywords`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keywordIds: selectedKeywords })
        });
        const data = await res.json();

        document.getElementById('saveResult').textContent = data.success
            ? '✅ 키워드 저장 완료'
            : `❌ 저장 실패: ${data.error}`;

        await loadUserKeywords();
    } catch (err) {
        console.error(err);
        alert('키워드 저장 중 오류 발생');
    }
}
</script>

</body>
</html>
