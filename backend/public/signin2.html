<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>회원가입</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; }
body { background-color:#fff; }
.container { width:393px; margin:0 auto; padding:20px; }
.header { display:flex; align-items:center; margin-bottom:30px; }
.back-button { font-size:24px; margin-right:10px; cursor:pointer; }
h1 { font-size:20px; text-align:center; flex-grow:1; margin-right:24px; }
.progress-bar { height:4px; background-color:#eee; margin-bottom:40px; }
.progress { width:33%; height:100%; background-color:#2ecc71; }
.title { font-size:24px; font-weight:bold; margin-bottom:10px; }
.subtitle { color:#666; font-size:14px; margin-bottom:40px; }
.form-group { margin-bottom:20px; }
.form-label { display:block; font-size:16px; margin-bottom:10px; }
.input-field, .dropdown {
  width:100%; padding:15px; border:none;
  background-color:#f5f5f5; border-radius:8px; font-size:16px; margin-bottom:10px;
}
.dropdown { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 9L0 0h12'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 15px center; }
.school-list { max-height:150px; overflow-y:auto; margin-top:5px; }
.school-item { display:flex; justify-content:space-between; margin-bottom:5px; background:#f0f0f0; padding:8px; border-radius:5px; }
.school-item button { padding: 4px 8px; border: none; background: #2ecc71; color: white; border-radius: 4px; cursor: pointer; }
.next-button {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  width:calc(100% - 40px); max-width:353px; padding:18px;
  background-color:#000; color:white; border:none; border-radius:25px; font-size:16px; cursor:pointer;
}
.error-message { color: red; font-size: 14px; margin-top: 5px; display: none; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <span class="back-button" onclick="history.back()">←</span>
    <h1>회원가입</h1>
  </div>

  <div class="progress-bar"><div class="progress" style="width: 66%;"></div></div> 
  <div class="title">회원님의<br>기본 정보를 채워주세요.</div>
  <p class="subtitle">나를 소개하는 정보를 입력하세요.</p>

  <div class="form-group">
    <label class="form-label">이름</label>
    <input type="text" id="userName" class="input-field" placeholder="이름을 입력해주세요.">
  </div>

  <div class="form-group">
    <label class="form-label">학교</label>
    <input type="text" id="schoolName" class="input-field" placeholder="학교를 입력해주세요." oninput="searchSchoolsDebounced()">
    <div id="schoolResults" class="school-list"></div>
    <input type="hidden" id="selectedSchoolId" value="">
    <input type="hidden" id="selectedSchoolName" value="">
    <div class="error-message" id="schoolError">학교를 검색하여 선택해주세요.</div>
  </div>

  <div class="form-group">
    <label class="form-label">학년</label>
    <select id="grade" class="dropdown">
      <option value="" disabled selected>학년을 선택해주세요.</option>
      <option value="1">1학년</option>
      <option value="2">2학년</option>
      <option value="3">3학년</option>
    </select>
  </div>

  <div class="form-group">
    <label class="form-label">반</label>
    <select id="classNum" class="dropdown">
      <option value="" disabled selected>반을 선택해주세요.</option>
      <script>
        for (let i = 1; i <= 15; i++) {
            document.write(`<option value="${i}">${i}반</option>`);
        }
      </script>
    </select>
  </div>

  <button class="next-button" onclick="registerUser()">다음</button>
</div>

<script>
let selectedSchool = null;
let searchTimeout = null;

// 학교 검색 디바운스
function searchSchoolsDebounced() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const query = document.getElementById('schoolName').value.trim();
    const container = document.getElementById('schoolResults');
    if (!query) {
      container.innerHTML = '';
      return; 
    }
    searchSchools(query);
  }, 400);
}

// 학교 검색 API
async function searchSchools(query) {
  const container = document.getElementById('schoolResults');
  container.innerHTML = '<div style="padding:8px;color:#666;">검색 중...</div>';
  try {
    const res = await fetch(`http://localhost:8080/api/schools/search?name=${encodeURIComponent(query)}`);
    if (!res.ok) throw new Error('검색 실패');
    const data = await res.json();
    container.innerHTML = '';
    document.getElementById('schoolError').style.display = 'none';
    if (data.success && data.data.length > 0) {
      data.data.forEach(s => {
        const div = document.createElement('div');
        div.className = 'school-item';
        div.innerHTML = `<span>${s.schoolName} (${s.officeName})</span>`;
        const btn = document.createElement('button');
        btn.textContent = '선택';
        btn.onclick = (e) => { e.stopPropagation(); selectSchool(s); };
        div.appendChild(btn);
        container.appendChild(div);
      });
    } else {
      container.textContent = '검색 결과가 없습니다.';
    }
  } catch (err) {
    console.error(err);
    container.textContent = '검색 중 오류 발생.';
  }
}

// 학교 선택
function selectSchool(s) {
  document.getElementById('schoolName').value = s.schoolName;
  document.getElementById('selectedSchoolId').value = s.schoolCode;
  document.getElementById('selectedSchoolName').value = s.schoolName;
  document.getElementById('schoolResults').innerHTML = '';
}

// 다음 단계
function registerUser() {
  const name = document.getElementById('userName').value.trim();
  const schoolId = document.getElementById('selectedSchoolId').value;
  const grade = document.getElementById('grade').value;
  const classNum = document.getElementById('classNum').value;

  if (!name) return alert('이름을 입력해주세요.');
  if (!schoolId) {
    document.getElementById('schoolError').style.display = 'block';
    return alert('학교를 선택해주세요.');
  }
  if (!grade) return alert('학년을 선택해주세요.');
  if (!classNum) return alert('반을 선택해주세요.');

  const userData = { name, schoolId, grade, classNum };
  sessionStorage.setItem('signupBasicData', JSON.stringify(userData));
  window.location.href = 'siginIn3.html'; // 다음 단계
}
</script>
</body>
</html>
