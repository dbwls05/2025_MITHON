<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>회원가입 - 키워드 선택</title>
<style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
    body{background:#fff}
    .frame{width:393px;height:852px;margin:0 auto;padding:18px 20px 24px;background:#fff;position:relative;overflow:hidden}
    .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .back{font-size:22px;cursor:pointer;user-select:none}
    .header-title{flex:1;text-align:center;font-weight:600;font-size:16px}
    .progress-wrap{height:6px;background:#e6e6e6;border-radius:4px;overflow:hidden;margin:8px 0 20px}
    .progress{height:100%;width:100%;background:#c6f08e}
    .page-title{font-size:20px;font-weight:700;line-height:1.2;margin-bottom:8px;color:#111}
    .subtitle{color:#9b9b9b;font-size:13px;margin-bottom:18px}
    .tags{display:flex;flex-wrap:wrap;gap:12px 12px}
    .tag{
        background:#eef9e6;
        color:#111;
        padding:10px 14px;
        border-radius:12px;
        font-size:13px;
        cursor:pointer;
        transition:background .16s,transform .08s;
        user-select:none;
    }
    .tag:active{transform:scale(.99)}
    .tag.selected{background:#c6f08e}
    .error-msg{color:#ff3b30;font-size:13px;text-align:center;margin-top:14px;display:none}
    .next-button{
        position:absolute;
        left:20px;
        bottom:20px;
        width:calc(100% - 40px);
        max-width:353px;
        height:56px;
        border-radius:28px;
        border:none;
        font-size:15px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:none;
    }
    .next-button.inactive{background:#d9d9d9;color:#6b6b6b;cursor:default}
    .next-button.active{background:#000;color:#fff}
    .tag, .back, .header-title, .page-title, .subtitle { -webkit-user-select:none; -ms-user-select:none; user-select:none; }
    
    .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .loading.show {
        display: flex;
    }
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #c6f08e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="frame" role="main" aria-labelledby="title">
        <div class="top">
            <div class="back" onclick="history.back()">←</div>
            <div class="header-title">회원가입</div>
        </div>

        <div class="progress-wrap" aria-hidden="true">
            <div class="progress"></div>
        </div>

        <div id="title" class="page-title">요즘 당신의 머릿속을<br/>채운 키워드는?</div>
        <div class="subtitle">이야기하고 싶은 주제를 모두 선택해주세요.</div>

        <div class="tags" id="tagsContainer" aria-live="polite" aria-atomic="true">
            <div class="tag" data-key="#오늘급식" onclick="toggleTag(this)">#오늘급식</div>
            <div class="tag" data-key="#수행평가" onclick="toggleTag(this)">#수행평가</div>
            <div class="tag" data-key="#시험공부" onclick="toggleTag(this)">#시험공부</div>
            <div class="tag" data-key="#음악/아이돌" onclick="toggleTag(this)">#음악/아이돌</div>
            <div class="tag" data-key="#영화/드라마" onclick="toggleTag(this)">#영화/드라마</div>
            <div class="tag" data-key="#친구/연애" onclick="toggleTag(this)">#친구/연애</div>
            <div class="tag" data-key="#고민상담" onclick="toggleTag(this)">#고민상담</div>
            <div class="tag" data-key="#웃긴썰" onclick="toggleTag(this)">#웃긴썰</div>
            <div class="tag" data-key="#창피한썰" onclick="toggleTag(this)">#창피한썰</div>
            <div class="tag" data-key="#질문있음" onclick="toggleTag(this)">#질문있음</div>
            <div class="tag" data-key="#TMI" onclick="toggleTag(this)">#TMI</div>
            <div class="tag" data-key="#아무말" onclick="toggleTag(this)">#아무말</div>
        </div>

        <p id="errorMsg" class="error-msg">선택하지 않았습니다. 선택해주세요.</p>

        <button id="nextBtn" class="next-button inactive" onclick="completeRegistration()">완료</button>
    </div>

<script>
    // 페이지 로드 시 이전 데이터 확인
    window.addEventListener('DOMContentLoaded', () => {
        if (!sessionStorage.getItem('tempIdname') || !sessionStorage.getItem('tempName')) {
            alert('잘못된 접근입니다.');
            window.location.href = 'signIn1.html';
        }
    });

    // 선택 토글 및 버튼 상태 업데이트
    function toggleTag(el){
        el.classList.toggle('selected');
        updateNextButton();
    }

    function updateNextButton(){
        const any = document.querySelectorAll('.tag.selected').length > 0;
        const btn = document.getElementById('nextBtn');
        if(any){
            btn.classList.remove('inactive');
            btn.classList.add('active');
            btn.setAttribute('aria-disabled','false');
        }else{
            btn.classList.remove('active');
            btn.classList.add('inactive');
            btn.setAttribute('aria-disabled','true');
        }
    }

    // 회원가입 완료
    async function completeRegistration(){
        const selected = document.querySelectorAll('.tag.selected');
        const err = document.getElementById('errorMsg');
        const btn = document.getElementById('nextBtn');

        // 비활성 상태면 에러만 표시
        if(selected.length === 0 || btn.classList.contains('inactive')){
            err.style.display = 'block';
            setTimeout(()=> err.style.display='none',3000);
            return;
        }

        // 선택된 키워드 값들 수집
        const keywords = Array.from(selected).map(el=>el.dataset.key);

        // sessionStorage에서 데이터 가져오기
        const idname = sessionStorage.getItem('tempIdname');
        const password = sessionStorage.getItem('tempPassword');
        const name = sessionStorage.getItem('tempName');
        const school = sessionStorage.getItem('tempSchool');
        const grade = parseInt(sessionStorage.getItem('tempGrade'));
        const classNum = parseInt(sessionStorage.getItem('tempClass'));
        const chatStyle = JSON.parse(sessionStorage.getItem('tempChatStyle') || '[]');

        // comment에 대화 스타일과 키워드 저장
        const comment = JSON.stringify({
            chatStyle: chatStyle,
            keywords: keywords
        });

        // 로딩 표시
        document.getElementById('loading').classList.add('show');

        try {
            // 1. 학교 등록 또는 조회
            const schoolResponse = await fetch('http://localhost:8080/api/schools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: school })
            });

            const schoolData = await schoolResponse.json();
            if (!schoolData.success) {
                throw new Error('학교 등록 실패');
            }

            const schoolId = schoolData.data.id;

            // 2. 사용자 등록
            const userResponse = await fetch('http://localhost:8080/api/users/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idname,
                    name,
                    password,
                    comment,
                    grade,
                    classNum,
                    schoolId,
                    profilePhoto: null
                })
            });

            const userData = await userResponse.json();

            if (userData.success) {
                // 회원가입 성공
                alert('회원가입이 완료되었습니다!');
                
                // 임시 데이터 삭제
                sessionStorage.clear();
                
                // 로그인 페이지로 이동
                window.location.href = 'index.html';
            } else {
                throw new Error(userData.error || '회원가입 실패');
            }

        } catch (error) {
            console.error('회원가입 에러:', error);
            alert('회원가입 중 오류가 발생했습니다: ' + error.message);
        } finally {
            document.getElementById('loading').classList.remove('show');
        }
    }

    // 엔터/스페이스로 버튼 작동하게 하기(접근성)
    document.addEventListener('keydown', function(e){
        const btn = document.getElementById('nextBtn');
        if((e.key === 'Enter' || e.key === ' ') && document.activeElement === btn){
            e.preventDefault();
            completeRegistration();
        }
    });

    // 초기 버튼 상태
    document.addEventListener('DOMContentLoaded', updateNextButton);
</script>
</body>
</html>
    }
    .loading.show {
        display: flex;
    }
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #c6f08e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }